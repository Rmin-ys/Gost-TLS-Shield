#!/bin/bash

# ==========================================
# ğŸš€ GOST ULTIMATE DASHBOARD v6.0
# Optimized for Stealth & Professional UI
# ==========================================

# Colors
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
BOLD='\033[1m'
NC='\033[0m'

# Check Gost
if [ ! -f "/usr/local/bin/gost" ]; then
    echo -e "${YELLOW}Wait... Installing Gost...${NC}"
    wget -qO gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz && gunzip gost.gz
    mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
fi

# Visual Elements
line="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
divider="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

header() {
    clear
    echo -e "${CYAN}$divider${NC}"
    echo -e "${BOLD}${MAGENTA}       ğŸ’ GOST SHIELD MANAGEMENT PANEL v6.0${NC}"
    echo -e "${CYAN}$divider${NC}"
}

show_status() {
    header
    if systemctl is-active --quiet gost-tunnel; then
        echo -e "${GREEN}  â— STATUS: TUNNEL IS ACTIVE${NC}"
        echo -e "${BLUE}  ğŸ“… UPTIME: $(systemctl show gost-tunnel --property=ActiveEnterTimestamp | cut -d'=' -f2)${NC}"
        echo -e "${CYAN}$line${NC}"
        echo -e "${BOLD}  ğŸ“¡ ACTIVE PORTS:${NC}"
        netstat -tlpn | grep gost | awk '{print "    âœ " $4}' | sed 's/0.0.0.0://g' | sed 's/::://g'
    else
        echo -e "${RED}  â—‹ STATUS: TUNNEL IS STOPPED${NC}"
    fi
    echo -e "${CYAN}$line${NC}"
    echo -e "${YELLOW}  ğŸ“ RECENT LOGS:${NC}"
    journalctl -u gost-tunnel -n 5 --no-pager | awk '{print "  " $0}' | cut -c1-60
    echo -e "${CYAN}$divider${NC}"
    read -p " Press Enter to return..."
}

setup_overseas() {
    header
    echo -e "${YELLOW}${BOLD}  [ EXIT NODE SETUP - OVERSEAS ]${NC}"
    echo -e "  Please enter the credentials for your tunnel:"
    echo ""
    read -p "  ğŸ”‘ Port (e.g. 443): " b_port
    read -p "  ğŸ‘¤ Username: " u_name
    read -p "  ğŸ”’ Password: " u_pass
    read -p "  ğŸ¯ Xray Port (Destination): " d_port
    
    EXEC_CMD="/usr/local/bin/gost -L ss://chacha20:$u_pass@:$b_port/127.0.0.1:$d_port"
    create_service "$EXEC_CMD"
}

setup_iran() {
    header
    echo -e "${YELLOW}${BOLD}  [ ENTRY NODE SETUP - IRAN ]${NC}"
    echo ""
    read -p "  ğŸŒ Overseas IP/Domain: " r_ip
    read -p "  ğŸ”‘ Bridge Port: " b_port
    read -p "  ğŸ‘¤ Username: " u_name
    read -p "  ğŸ”’ Password: " u_pass
    read -p "  ğŸ”Œ Local Ports (e.g. 8885,8443): " raw_ports
    
    # Auto-fix Persian characters
    ports=$(echo $raw_ports | sed 's/Ùˆ/,/g' | tr -d ' ')
    
    IFS=',' read -ra ADDR <<< "$ports"
    ARGS=""
    for i in "${ADDR[@]}"; do
        ARGS+="-L tcp://:$i/127.0.0.1:$i "
    done
    
    EXEC_CMD="/usr/local/bin/gost $ARGS -F ss://chacha20:$u_pass@$r_ip:$b_port"
    create_service "$EXEC_CMD"
}

create_service() {
    local cmd=$1
    echo -e "\n${YELLOW}  âš™ï¸ Deploying Service...${NC}"
    killall -9 gost 2>/dev/null
    cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost Secure Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$cmd
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable gost-tunnel >/dev/null 2>&1
    systemctl restart gost-tunnel
    echo -e "${GREEN}${BOLD}  âœ” SUCCESS! Your tunnel is now live.${NC}"
    sleep 2
}

# Main Menu
while true; do
    header
    echo -e "  ${BOLD}${GREEN}1)${NC} Setup Iran Server"
    echo -e "  ${BOLD}${GREEN}2)${NC} Setup Overseas Server"
    echo -e "  ${BOLD}${CYAN}3)${NC} View Live Dashboard"
    echo -e "  ${BOLD}${RED}4)${NC} Stop & Clear Tunnel"
    echo -e "  ${BOLD}${YELLOW}5)${NC} Exit"
    echo -e "${CYAN}$divider${NC}"
    read -p "  Select an option [1-5]: " opt

    case $opt in
        1) setup_iran ;;
        2) setup_overseas ;;
        3) show_status ;;
        4) systemctl stop gost-tunnel; killall -9 gost; echo -e "${RED}  Stopped.${NC}"; sleep 1 ;;
        5) exit 0 ;;
        *) echo -e "${RED}  Invalid!${NC}"; sleep 1 ;;
    esac
done
