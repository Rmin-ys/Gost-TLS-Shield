#!/bin/bash

# Gost TLS Shield - Smart Tunnel Manager
# Created for High-Security Environments (2026)

# Colors for UI
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

clear
echo -e "${YELLOW}==============================================${NC}"
echo -e "${GREEN}      Gost TLS Shield - Auto Installer       ${NC}"
echo -e "${YELLOW}==============================================${NC}"

# Check Root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root!${NC}"
   exit 1
fi

# Function to Install Gost
install_gost() {
    if [ ! -f "/usr/local/bin/gost" ]; then
        echo -e "${YELLOW}Installing Gost...${NC}"
        arch=$(uname -m)
        case $arch in
            x86_64) url="https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz" ;;
            aarch64) url="https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-arm8-2.11.5.gz" ;;
            *) echo -e "${RED}Architecture not supported!${NC}"; exit 1 ;;
        esac
        wget -qO gost.gz $url && gunzip gost.gz
        mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
        echo -e "${GREEN}Gost installed successfully.${NC}"
    else
        echo -e "${GREEN}Gost is already installed.${NC}"
    fi
}

# Function to Enable BBR (Speed Optimization)
enable_bbr() {
    if ! sysctl net.ipv4.tcp_congestion_control | grep -q "bbr"; then
        echo -e "${YELLOW}Enabling BBR for better speed...${NC}"
        echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
        sysctl -p
        echo -e "${GREEN}BBR Enabled.${NC}"
    fi
}

# Main Menu
echo -e "Select Server Role:"
echo -e "1) ${GREEN}Iran Server${NC} (Bridge/Forwarder)"
echo -e "2) ${YELLOW}Overseas Server${NC} (Destination/End-point)"
echo -e "3) ${RED}Uninstall/Stop Tunnel${NC}"
read -p "Choice: " choice

case $choice in
    1)
        install_gost
        enable_bbr
        read -p "Enter Tunnel User (e.g. admin): " g_user
        read -p "Enter Tunnel Pass (e.g. 123456): " g_pass
        read -p "Enter Target Port (Port on Iran server): " l_port
        read -p "Enter Overseas IP or Domain: " r_ip
        read -p "Enter Overseas Port (default 443): " r_port
        r_port=${r_port:-443}
        
        EXEC_CMD="/usr/local/bin/gost -L tcp://:$l_port -F relay+tls://$g_user:$g_pass@$r_ip:$r_port"
        ;;
    2)
        install_gost
        enable_bbr
        read -p "Enter Tunnel User: " g_user
        read -p "Enter Tunnel Pass: " g_pass
        read -p "Enter Tunnel Listen Port (default 443): " l_port
        l_port=${l_port:-443}
        read -p "Enter Final Destination Port (e.g. 8875): " d_port
        
        EXEC_CMD="/usr/local/bin/gost -L relay+tls://$g_user:$g_pass@:$l_port/127.0.0.1:$d_port"
        ;;
    3)
        systemctl stop gost-tunnel && systemctl disable gost-tunnel
        rm /etc/systemd/system/gost-tunnel.service
        echo -e "${RED}Tunnel stopped and service removed.${NC}"
        exit 0
        ;;
    *)
        echo "Invalid choice."; exit 1 ;;
esac

# Create Service
cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost TLS Shield Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$EXEC_CMD
Restart=always
RestartSec=5
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable gost-tunnel
systemctl restart gost-tunnel

echo -e "${GREEN}==============================================${NC}"
echo -e "${GREEN}   SUCCESS! Tunnel is running as a service.   ${NC}"
echo -e "   Use 'systemctl status gost-tunnel' to check.${NC}"
echo -e "${GREEN}==============================================${NC}"
