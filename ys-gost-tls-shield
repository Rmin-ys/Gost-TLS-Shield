#!/bin/bash

# ==========================================
# Gost-Shield v4.9 (Stealth WSS Edition)
# Fixed Disconnection & Improved Stability
# ==========================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

header() {
    clear
    echo -e "${PURPLE}==================================================${NC}"
    echo -e "${GREEN}       GOST STEALTH WSS MANAGER v4.9${NC}"
    echo -e "${PURPLE}==================================================${NC}"
}

setup_iran() {
    header
    echo -e "${YELLOW}Step 1: Overseas Details (Stealth Mode)${NC}"
    read -p "  Enter Domain (e.g. my.domain.com): " domain
    read -p "  Bridge Port (Recommended 443): " b_port
    read -p "  Password (Secret): " s_pass
    echo -e "${YELLOW}Step 2: Local Ports${NC}"
    read -p "  Enter Ports (e.g. 8885,8875): " raw_ports
    
    ports=$(echo $raw_ports | sed 's/و/,/g' | tr -d ' ')
    IFS=',' read -ra ADDR <<< "$ports"
    ARGS=""
    for i in "${ADDR[@]}"; do
        ARGS+="-L tcp://:$i/127.0.0.1:$i "
    done

    # اتصال از طریق Websocket Secure برای عبور از فیلترینگ هوشمند
    EXEC_CMD="/usr/local/bin/gost $ARGS -F wss://admin:$s_pass@$domain:$b_port?path=/ws&mptcp=true"
    create_service "$EXEC_CMD"
}

setup_overseas() {
    header
    echo -e "${YELLOW}Overseas Stealth Setup${NC}"
    read -p "  Listen Port (Usually 443): " b_port
    read -p "  Password (Secret): " s_pass
    read -p "  Destination Port (Xray Port): " d_port
    
    # گوش دادن در لایه WSS و هدایت به پورت محلی
    EXEC_CMD="/usr/local/bin/gost -L wss://admin:$s_pass@:$b_port/127.0.0.1:$d_port?path=/ws"
    create_service "$EXEC_CMD"
}

show_status() {
    header
    if systemctl is-active --quiet gost-tunnel; then
        echo -e "Status: ${GREEN}● ACTIVE${NC}"
        echo -e "Active Tunnels:"
        netstat -tlpn | grep gost | awk '{print "  -> " $4}'
    else
        echo -e "Status: ${RED}○ INACTIVE${NC}"
    fi
    echo -e "\n${YELLOW}Last Logs:${NC}"
    journalctl -u gost-tunnel -n 10 --no-pager
    read -p "Press Enter..."
}

create_service() {
    local cmd=$1
    killall -9 gost 2>/dev/null
    cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost Stealth Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$cmd
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable gost-tunnel >/dev/null 2>&1
    systemctl restart gost-tunnel
    echo -e "${GREEN}✔ Stealth Tunnel Activated Successfully!${NC}"
    sleep 2
}

while true; do
    header
    echo "1) Setup Iran (Stealth)"
    echo "2) Setup Overseas (Stealth)"
    echo "3) Check Status / Logs"
    echo "4) Stop / Uninstall"
    echo "5) Exit"
    read -p "Selection: " opt
    case $opt in
        1) setup_iran ;;
        2) setup_overseas ;;
        3) show_status ;;
        4) systemctl stop gost-tunnel; killall -9 gost; echo "Stopped.";;
        5) exit ;;
    esac
done
