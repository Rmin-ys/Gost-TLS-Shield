#!/bin/bash

# Gost-TLS-Shield v3.0 (Smart UI & Multi-Port)
# Created by Rmin-ys

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Functions for UI
draw_line() { echo -e "${BLUE}--------------------------------------------------${NC}"; }
header() {
    clear
    echo -e "${CYAN}"
    echo "  ██████╗  ██████╗ ███████╗████████╗"
    echo " ██╔════╝ ██╔═══██╗██╔════╝╚══██╔══╝"
    echo " ██║  ███╗██║   ██║███████╗   ██║   "
    echo " ██║   ██║██║   ██║╚════██║   ██║   "
    echo " ╚██████╔╝╚██████╔╝███████║   ██║   "
    echo "  ╚═════╝  ╚═════╝ ╚══════╝   ╚═╝   "
    echo -e "          Gost TLS Shield v3.0${NC}"
    draw_line
}

# Check for Gost
check_gost() {
    if [ ! -f "/usr/local/bin/gost" ]; then
        echo -e "${YELLOW}Installing Gost...${NC}"
        wget -qO gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz && gunzip gost.gz
        mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
    fi
}

# Status Function
show_status() {
    header
    echo -e "${YELLOW}Tunnel Status:${NC}"
    if systemctl is-active --quiet gost-tunnel; then
        echo -e "Status: ${GREEN}Active (Running)${NC}"
        echo -e "\n${YELLOW}Active Port Forwarding:${NC}"
        journalctl -u gost-tunnel -n 20 --no-pager | grep -i "listen" | tail -n 5
    else
        echo -e "Status: ${RED}Inactive (Stopped)${NC}"
    fi
    draw_line
    read -p "Press Enter to return to menu..."
}

# Main Menu
main_menu() {
    while true; do
        header
        echo -e "1) ${GREEN}Setup Iran Server${NC}"
        echo -e "2) ${GREEN}Setup Overseas Server${NC}"
        echo -e "3) ${BLUE}Show Tunnel Status & Logs${NC}"
        echo -e "4) ${RED}Uninstall / Stop Tunnel${NC}"
        echo -e "5) Exit"
        draw_line
        read -p "Select an option [1-5]: " main_opt

        case $main_opt in
            1) setup_server "iran" ;;
            2) setup_server "overseas" ;;
            3) show_status ;;
            4) 
                systemctl stop gost-tunnel && systemctl disable gost-tunnel
                rm -f /etc/systemd/system/gost-tunnel.service
                echo -e "${RED}Tunnel uninstalled.${NC}"
                sleep 2
                ;;
            5) exit 0 ;;
            *) echo -e "${RED}Invalid option!${NC}"; sleep 1 ;;
        esac
    done
}

# Setup Logic
setup_server() {
    local mode=$1
    header
    echo -e "${YELLOW}Configuring $mode Server${NC}"
    echo -e "${CYAN}(Enter 0 at any time to go back)${NC}\n"

    read -p "Tunnel Username: " g_user
    [[ "$g_user" == "0" ]] && return

    read -p "Tunnel Password: " g_pass
    [[ "$g_pass" == "0" ]] && return

    read -p "Bridge Port (between servers, default 443): " b_port
    [[ "$b_port" == "0" ]] && return
    b_port=${b_port:-443}

    if [ "$mode" == "iran" ]; then
        read -p "Enter Target Ports (e.g. 8875,8885): " ports
        [[ "$ports" == "0" ]] && return
        read -p "Overseas Server IP: " r_ip
        [[ "$r_ip" == "0" ]] && return

        IFS=',' read -ra ADDR <<< "$ports"
        ARGS=""
        for i in "${ADDR[@]}"; do ARGS+="-L tcp://:$i/127.0.0.1:$i "; done
        EXEC_CMD="/usr/local/bin/gost $ARGS -F mwss://$g_user:$g_pass@$r_ip:$b_port"
    else
        read -p "Enter Destination Ports (e.g. 8875,8885): " ports
        [[ "$ports" == "0" ]] && return
        
        IFS=',' read -ra ADDR <<< "$ports"
        ARGS=""
        for i in "${ADDR[@]}"; do ARGS+="-L tcp://:127.0.0.1:$i/127.0.0.1:$i "; done
        EXEC_CMD="/usr/local/bin/gost -L mwss://$g_user:$g_pass@:$b_port $ARGS"
    fi

    # Create Service
    check_gost
    cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost High Speed Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$EXEC_CMD
Restart=always
RestartSec=5
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable gost-tunnel
    systemctl restart gost-tunnel
    echo -e "\n${GREEN}Success! Tunnel configured and started.${NC}"
    sleep 3
}

# Start Script
main_menu
