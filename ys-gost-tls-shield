#!/bin/bash

# ==========================================
# Gost-TLS-Shield v3.3 (Zero-Conflict Edition)
# Optimized for Xray/Panel Co-existence
# Created by Rmin-ys (2026)
# ==========================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# UI Functions
draw_line() { echo -e "${BLUE}--------------------------------------------------${NC}"; }
header() {
    clear
    echo -e "${CYAN}"
    echo "  ██████╗  ██████╗ ███████╗████████╗"
    echo " ██╔════╝ ██╔═══██╗██╔════╝╚══██╔══╝"
    echo " ██║  ███╗██║   ██║███████╗   ██║   "
    echo " ██║   ██║██║   ██║╚════██║   ██║   "
    echo " ╚██████╔╝╚██████╔╝███████║   ██║   "
    echo "  ╚═════╝  ╚═════╝ ╚══════╝   ╚═╝   "
    echo -e "          Gost TLS Shield v3.3${NC}"
    draw_line
}

# Optimization (BBR)
enable_bbr() {
    if ! sysctl net.ipv4.tcp_congestion_control | grep -q "bbr"; then
        echo -e "${YELLOW}Optimizing Network (BBR)...${NC}"
        echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
        sysctl -p > /dev/null 2>&1
    fi
}

# Install Gost
check_gost() {
    if [ ! -f "/usr/local/bin/gost" ]; then
        echo -e "${YELLOW}Downloading Gost...${NC}"
        arch=$(uname -m)
        case $arch in
            x86_64) url="https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz" ;;
            aarch64) url="https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-arm8-2.11.5.gz" ;;
            *) echo -e "${RED}Arch not supported!${NC}"; exit 1 ;;
        esac
        wget -qO gost.gz $url && gunzip gost.gz
        mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
    fi
}

# Status
show_status() {
    header
    echo -e "${YELLOW}Tunnel Service Status:${NC}"
    if systemctl is-active --quiet gost-tunnel; then
        echo -e "Status: ${GREEN}● Active (Running)${NC}"
        echo -e "\n${YELLOW}Running Process Detail:${NC}"
        ps aux | grep gost | grep -v grep | awk '{for(i=11;i<=NF;i++) printf "%s ", $i; print ""}'
    else
        echo -e "Status: ${RED}○ Inactive (Stopped/Failed)${NC}"
        echo -e "\n${RED}Error Log (Last 5 lines):${NC}"
        journalctl -u gost-tunnel -n 5 --no-pager
    fi
    draw_line
    read -p "Press Enter to return to menu..."
}

# Setup Logic
setup_server() {
    local mode=$1
    header
    echo -e "${YELLOW}Configuring $mode Server${NC}"
    echo -e "${CYAN}(Enter 0 to go back)${NC}\n"

    read -p "Tunnel Username: " g_user
    g_user=$(echo "$g_user" | tr -cd '[:alnum:]')
    [[ "$g_user" == "0" || -z "$g_user" ]] && return

    read -p "Tunnel Password: " g_pass
    g_pass=$(echo "$g_pass" | tr -cd '[:alnum:]')
    [[ "$g_pass" == "0" || -z "$g_pass" ]] && return

    read -p "Bridge Port (Listen Port, default 443): " b_port
    [[ "$b_port" == "0" ]] && return
    b_port=${b_port:-443}

    if [ "$mode" == "iran" ]; then
        read -p "Enter Local Ports (e.g. 8875,8885): " ports
        [[ "$ports" == "0" ]] && return
        read -p "Overseas Server IP: " r_ip
        [[ "$r_ip" == "0" ]] && return

        IFS=',' read -ra ADDR <<< "$ports"
        ARGS=""
        for i in "${ADDR[@]}"; do
            ARGS+="-L tcp://:$i/127.0.0.1:$i "
        done
        EXEC_CMD="/usr/local/bin/gost $ARGS -F relay+tls://$g_user:$g_pass@$r_ip:$b_port"
    else
        # در سرور خارج فقط پورت بریج باز می‌شود تا با Xray تداخل نداشته باشد
        EXEC_CMD="/usr/local/bin/gost -L relay+tls://$g_user:$g_pass@:$b_port"
    fi

    # Installation & Service Creation
    check_gost
    enable_bbr
    killall -9 gost 2>/dev/null

    cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost Stable Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$EXEC_CMD
Restart=always
RestartSec=5
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable gost-tunnel
    systemctl restart gost-tunnel
    
    echo -e "\n${GREEN}Setup Complete! Checking status...${NC}"
    sleep 2
    show_status
}

# Main Menu
while true; do
    header
    echo -e "1) ${GREEN}Setup Iran Server${NC}"
    echo -e "2) ${GREEN}Setup Overseas Server${NC}"
    echo -e "3) ${BLUE}Show Status & Logs${NC}"
    echo -e "4) ${RED}Uninstall / Stop Tunnel${NC}"
    echo -e "5) Exit"
    draw_line
    read -p "Select option [1-5]: " opt

    case $opt in
        1) setup_server "iran" ;;
        2) setup_server "overseas" ;;
        3) show_status ;;
        4)
            systemctl stop gost-tunnel && systemctl disable gost-tunnel
            rm -f /etc/systemd/system/gost-tunnel.service
            killall -9 gost 2>/dev/null
            echo -e "${RED}Tunnel uninstalled.${NC}"; sleep 2 ;;
        5) exit 0 ;;
        *) echo -e "${RED}Invalid!${NC}"; sleep 1 ;;
    esac
done
