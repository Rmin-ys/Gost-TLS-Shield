#!/bin/bash

# ==========================================
# Gost-Shield v4.8 (Ultimate UI Edition)
# Optimized for Stealth, Speed & Management
# ==========================================

# Colors & Formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Check Gost Installation
if [ ! -f "/usr/local/bin/gost" ]; then
    echo -e "${YELLOW}Installing Gost...${NC}"
    wget -qO gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz && gunzip gost.gz
    mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
fi

# UI Elements
draw_line() { echo -e "${CYAN}--------------------------------------------------${NC}"; }
draw_double_line() { echo -e "${BLUE}==================================================${NC}"; }

header() {
    clear
    echo -e "${PURPLE}${BOLD}"
    echo "  ðŸš€ GOST SHIELD ULTIMATE v4.8"
    echo "     Secure & Stealthy Tunneling"
    echo -e "${NC}"
    draw_double_line
}

# Function to show detailed status
show_status() {
    header
    if systemctl is-active --quiet gost-tunnel; then
        echo -e "Status: ${GREEN}${BOLD}â— ACTIVE (RUNNING)${NC}"
        echo -e "Uptime: ${CYAN}$(systemctl show gost-tunnel --property=ActiveEnterTimestamp | cut -d'=' -f2)${NC}"
        draw_line
        echo -e "${YELLOW}${BOLD}ACTIVE TUNNELS:${NC}"
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        CMD=$(ps aux | grep gost | grep -v grep)
        if [[ $CMD == *"ss://"* ]]; then
            echo -e "${BLUE}Protocol:${NC} Shadowsocks (ChaCha20)"
            # Ù†Ù…Ø§ÛŒØ´ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ³Ù† Ø´Ø¯Ù‡
            echo -e "${BLUE}Monitoring Ports:${NC}"
            netstat -tlpn | grep gost | awk '{print "  -> " $4}' | sed 's/0.0.0.0://g' | sed 's/::://g'
        fi
    else
        echo -e "Status: ${RED}${BOLD}â—‹ INACTIVE (STOPPED)${NC}"
    fi
    draw_line
    echo -e "${CYAN}Last 5 Logs:${NC}"
    journalctl -u gost-tunnel -n 5 --no-pager | cut -c1-60
    draw_line
    read -p "Press Enter to return..."
}

setup_iran() {
    header
    echo -e "${YELLOW}Step 1: Overseas Connection Details${NC}"
    read -p "  IP Address: " r_ip
    read -p "  Bridge Port: " b_port
    read -p "  Password: " s_pass
    draw_line
    echo -e "${YELLOW}Step 2: Local Ports (Xray Ports)${NC}"
    read -p "  Enter Ports (comma separated, e.g. 8885,444): " ports
    
    IFS=',' read -ra ADDR <<< "$ports"
    ARGS=""
    for i in "${ADDR[@]}"; do
        ARGS+="-L tcp://:$i/127.0.0.1:$i "
    done
    
    EXEC_CMD="/usr/local/bin/gost $ARGS -F ss://chacha20:$s_pass@$r_ip:$b_port"
    create_service "$EXEC_CMD"
}

setup_overseas() {
    header
    echo -e "${YELLOW}Setup Gateway (Overseas)${NC}"
    read -p "  Listen Port (Bridge): " b_port
    read -p "  Encryption Password: " s_pass
    
    EXEC_CMD="/usr/local/bin/gost -L ss://chacha20:$s_pass@:$b_port"
    create_service "$EXEC_CMD"
}

create_service() {
    local cmd=$1
    echo -e "\n${YELLOW}Applying configuration...${NC}"
    killall -9 gost 2>/dev/null
    cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost Secure Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$cmd
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable gost-tunnel >/dev/null 2>&1
    systemctl restart gost-tunnel
    echo -e "${GREEN}${BOLD}âœ” SUCCESS! Tunnel is now active.${NC}"
    sleep 2
}

# Main Loop
while true; do
    header
    echo -e " 1) ${GREEN}Setup Iran Server (Entry Point)${NC}"
    echo -e " 2) ${GREEN}Setup Overseas Server (Exit Point)${NC}"
    echo -e " 3) ${CYAN}Check Status & Dashboard${NC}"
    echo -e " 4) ${RED}Stop & Uninstall Tunnel${NC}"
    echo -e " 5) Exit"
    draw_double_line
    read -p " Selection [1-5]: " opt

    case $opt in
        1) setup_iran ;;
        2) setup_overseas ;;
        3) show_status ;;
        4) 
            systemctl stop gost-tunnel
            systemctl disable gost-tunnel >/dev/null 2>&1
            killall -9 gost 2>/dev/null
            echo -e "${RED}Tunnel stopped and service disabled.${NC}"
            sleep 2 ;;
        5) exit 0 ;;
        *) echo -e "${RED}Invalid option!${NC}"; sleep 1 ;;
    esac
done
