#!/bin/bash

# ==========================================
# Gost-Shield v6.2 (Classic UI - Turbo Tech)
# ==========================================

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check Gost
if [ ! -f "/usr/local/bin/gost" ]; then
    echo -e "${YELLOW}Installing Gost...${NC}"
    wget -qO gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz && gunzip gost.gz
    mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
fi

header() {
    clear
    echo -e "${BLUE}==================================================${NC}"
    echo -e "${GREEN}          GOST CLASSIC MANAGER v6.2${NC}"
    echo -e "${BLUE}==================================================${NC}"
}

setup_iran() {
    header
    read -p "Enter Overseas IP: " r_ip
    read -p "Enter Bridge Port: " b_port
    read -p "Enter Password: " s_pass
    read -p "Enter Local Ports (e.g. 8885,444): " raw_ports
    
    # اصلاح خودکار کاراکترهای فارسی و فاصله‌ها
    ports=$(echo $raw_ports | sed 's/و/,/g' | tr -d ' ')
    
    IFS=',' read -ra ADDR <<< "$ports"
    ARGS=""
    for i in "${ADDR[@]}"; do
        ARGS+="-L tcp://:$i/127.0.0.1:$i "
    done

    # اضافه کردن پارامترهای سرعت (MTU و TFO)
    EXEC_CMD="/usr/local/bin/gost $ARGS -F ss://chacha20:$s_pass@$r_ip:$b_port?mtu=1350&tfo=true"
    create_service "$EXEC_CMD"
}

setup_overseas() {
    header
    read -p "Enter Bridge Port: " b_port
    read -p "Enter Password: " s_pass
    read -p "Enter Destination Port (Xray Port): " d_port
    
    EXEC_CMD="/usr/local/bin/gost -L ss://chacha20:$s_pass@:$b_port/127.0.0.1:$d_port?tfo=true"
    create_service "$EXEC_CMD"
}

create_service() {
    local cmd=$1
    killall -9 gost 2>/dev/null
    cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost Secure Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$cmd
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable gost-tunnel >/dev/null 2>&1
    systemctl restart gost-tunnel
    echo -e "${GREEN}Service Started Successfully!${NC}"
    sleep 2
}

# Main Menu
header
echo "1) Setup Iran Server"
echo "2) Setup Overseas Server"
echo "3) Show Status & Logs"
echo "4) Uninstall / Stop"
echo "5) Exit"
read -p "Select: " opt

case $opt in
    1) setup_iran ;;
    2) setup_overseas ;;
    3) header; journalctl -u gost-tunnel -n 15 --no-pager; read -p "Press Enter..." ;;
    4) systemctl stop gost-tunnel; killall -9 gost; echo "Stopped.";;
    5) exit ;;
esac
