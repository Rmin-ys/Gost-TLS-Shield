#!/bin/bash
# Gost-TLS-Shield v2.0 (High Speed & Multi-Port)

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

clear
echo -e "${GREEN}Upgrading to Gost-TLS-Shield v2.0 (High Speed Edition)${NC}"

# Install Gost
if [ ! -f "/usr/local/bin/gost" ]; then
    wget -qO gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz && gunzip gost.gz
    mv gost /usr/local/bin/gost && chmod +x /usr/local/bin/gost
fi

echo "Select Server Role:"
echo "1) Iran (Multi-Port)"
echo "2) Overseas (Multi-Port)"
read -p "Choice: " choice

read -p "User: " g_user
read -p "Pass: " g_pass
read -p "Bridge Port (default 443): " b_port
b_port=${b_port:-443}

if [ "$choice" == "1" ]; then
    read -p "Enter Target Ports (comma separated, e.g. 8875,8885,8485): " ports
    read -p "Overseas IP: " r_ip
    
    # Generate Multi-Port Command
    IFS=',' read -ra ADDR <<< "$ports"
    ARGS=""
    for i in "${ADDR[@]}"; do
        ARGS+="-L tcp://:$i/127.0.0.1:$i "
    done
    # Using mws for higher speed
    EXEC_CMD="/usr/local/bin/gost $ARGS -F mwss://$g_user:$g_pass@$r_ip:$b_port"

else
    read -p "Enter Destination Ports (comma separated, e.g. 8875,8885,8485): " ports
    
    IFS=',' read -ra ADDR <<< "$ports"
    ARGS=""
    for i in "${ADDR[@]}"; do
        ARGS+="-L tcp://:127.0.0.1:$i/127.0.0.1:$i "
    done
    EXEC_CMD="/usr/local/bin/gost -L mwss://$g_user:$g_pass@:$b_port $ARGS"
fi

# Create Systemd Service
cat <<EOF > /etc/systemd/system/gost-tunnel.service
[Unit]
Description=Gost High Speed Tunnel
After=network.target

[Service]
Type=simple
ExecStart=$EXEC_CMD
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl restart gost-tunnel
echo -e "${GREEN}Multi-port Tunnel is Active with MWSS protocol!${NC}"
